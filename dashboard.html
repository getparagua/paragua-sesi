<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SESI - Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="SESI dashboard: realized vs structural vs expected stress, dislocation, and validation.">

  <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/style.css">

  <style>
    .frame-wrap{
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: var(--surface);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .chart-frame{
      width: 100%;
      height: 520px;
      border: 0;
      display: block;
      background: white;
    }
    @media (max-width: 720px){
      .chart-frame{ height: 460px; }
    }
    .chart-caption{
      padding: 12px 14px;
      border-top: 1px solid var(--border);
      background: var(--surface);
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      font-size: 0.84em;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--surface-2);
      margin-right: 8px;
      margin-top: 6px;
      flex-wrap: wrap;
    }
    .pill strong{ font-weight: 750; }
    .mini-note{
      margin-top: 10px;
      line-height: 1.6;
    }
  </style>
</head>

<body>

  <div class="nav">
    <div class="nav-left">
      <img class="brand-mini" src="assets/img/paragua-logo_little.png" alt="Paragua Software">
      <div class="brand-title">
        <strong>Paragua Market Signals</strong>
        <span>Independent research & benchmarks</span>
      </div>
    </div>

    <div class="nav-links">
      <a class="btn" href="index.html">Home</a>
      <a class="btn primary" href="dashboard.html">Dashboard</a>
      <a class="btn" href="methodology.html">Methodology</a>
      <a class="btn" href="data-access.html">Data access</a>
    </div>
  </div>

  <div class="hero">
    <h1>Dashboard</h1>
    <h2>Canonical views (v0.1, frozen)</h2>
    <p class="subtitle">
      SESI is a percentile benchmark (0–100). Think of it as a <strong>ranking</strong>:
      higher = rarer and more stressed compared to history.
    </p>

    <div class="pill" id="todayPill">Loading today…</div>
    <div class="muted mini-note" id="valPill">Loading validation…</div>
  </div>

  <section>
    <h3>Stress dashboard</h3>
    <p class="muted">
      Percentiles are historical rankings (0–100), not probabilities.
      The key reading is the relative alignment of <strong>Realized</strong>, <strong>Structural</strong>, and <strong>Expected</strong>.
    </p>

    <div class="frame-wrap">
      <iframe
        class="chart-frame"
        src="assets/charts/stress.html"
        title="SESI stress chart"
        loading="lazy"
      ></iframe>

      <div class="chart-caption">
        <div class="muted"><strong>How to read (simple)</strong></div>
        <ul>
          <li><strong>SESI (realized)</strong>: what’s happening now in spot (stress rank).</li>
          <li><strong>SESI_structural</strong>: how tight the background regime is vs pre-2022.</li>
          <li><strong>OMIP expected (pct)</strong>: what forward prices imply for the next months (rank vs pre-2022).</li>
        </ul>
        <p class="muted" style="margin-top:10px;">
          The useful insight is often the <strong>gap</strong> between expected and structural:
          discounting (expected much lower) vs risk bid (expected higher).
        </p>
      </div>
    </div>
  </section>

  <section>
    <h3>Dislocation</h3>
    <p class="muted">
      Dislocation is:
      <strong>D = OMIP_expected_percentile − SESI_structural</strong> (percentile points).
      Positive = forward pricing above structural. Negative = forward pricing below it.
    </p>

    <div class="frame-wrap">
      <iframe
        class="chart-frame"
        src="assets/charts/dislocation.html"
        title="SESI dislocation chart"
        loading="lazy"
      ></iframe>

      <div class="chart-caption">
        <div class="muted"><strong>How to read</strong></div>
        <ul>
          <li><strong>D ≤ −25</strong>: strong discounting (forward pricing normalization).</li>
          <li><strong>D ≥ +25</strong>: risk bid (forward pricing additional stress).</li>
          <li><strong>|D| ≥ 15</strong>: meaningfully dislocated.</li>
        </ul>
      </div>
    </div>
  </section>

  <section id="validation">
    <h3>Validation: “what usually happens next”</h3>
    <p class="muted">
      This is the simplest check: in the past, when SESI regimes looked like this, how much did prices typically move afterwards?
      The chart below shows the <strong>median 7-day max move</strong> (€/MWh) by regime state (threshold = 80).
    </p>

    <div class="frame-wrap">
      <iframe
        class="chart-frame"
        src="assets/charts/validation.html"
        title="SESI validation chart"
        loading="lazy"
      ></iframe>

      <div class="chart-caption">
        <div class="muted"><strong>How to read</strong></div>
        <ul>
          <li>First we classify the day into a regime (Calm / Latent risk / Realized stress / Full crisis).</li>
          <li>Then we look at the next 7 days and ask: <strong>what was the biggest move from today’s price?</strong></li>
          <li>The bar shows the <strong>median</strong> of those “biggest moves” across history.</li>
        </ul>
        <p class="muted" style="margin-top:10px;">
          These are historical conditional statistics: descriptive, not forecasts.
        </p>

        <p style="margin-top:10px;">
          <a class="btn" href="assets/public/validation_summary.json">Open validation summary (JSON)</a>
          <!-- Optional, only if you actually publish it:
          <a class="btn" href="assets/public/quadrants_summary.csv">Open regime table (CSV, aggregated)</a>
          -->
          <a class="btn" href="data-access.html">What is public?</a>
        </p>
      </div>
    </div>
  </section>

  <footer>
    <div class="footer-links">
      <a href="index.html">Home</a>
      <a href="methodology.html">Methodology</a>
      <a href="data-access.html">Data access</a>
    </div>
  </footer>

  <script>
    function fmtNum(x, decimals){
      if (x === null || x === undefined) return "-";
      if (typeof x !== "number" || Number.isNaN(x)) return "-";
      return x.toFixed(decimals);
    }

    function classifyQuadrant(sesi, structural, thr) {
      if (sesi === null || structural === null) return null;
      const xHigh = structural >= thr;
      const yHigh = sesi >= thr;
      if (!yHigh && !xHigh) return "Calm";
      if (!yHigh && xHigh) return "Latent risk";
      if (yHigh && !xHigh) return "Realized stress";
      return "Full crisis";
    }

    function pickRowByQuadrant(v, quad){
      if (!v || !Array.isArray(v.rows) || !quad) return null;
      return v.rows.find(r => (r["Quadrant"] === quad) || (r["quadrant"] === quad)) || null;
    }

    function pickField(row, keys){
      if (!row) return null;
      for (const k of keys){
        if (row[k] !== undefined && row[k] !== null) return row[k];
      }
      return null;
    }

    (async function(){
      try{
        // ----------------
        // Today snapshot
        // ----------------
        const res = await fetch("assets/public/today.json", { cache: "no-store" });
        if (!res.ok) throw new Error("today.json not found");
        const d = await res.json();

        const date = d.asof_date || d.date || "-";
        const sesi = (typeof d.SESI === "number") ? d.SESI : null;
        const structural = (typeof d.SESI_structural === "number") ? d.SESI_structural : null;

        const omipPct = (d.OMIP && typeof d.OMIP.omip_exp_pct_pre2022 === "number")
          ? d.OMIP.omip_exp_pct_pre2022 : null;

        const disloc = (d.OMIP && typeof d.OMIP.dislocation_pct_pts === "number")
          ? d.OMIP.dislocation_pct_pts : null;

        const label = (d.OMIP && d.OMIP.decision_label) ? d.OMIP.decision_label : (d.regime || "");
        const flags = (d.OMIP && Array.isArray(d.OMIP.regime_flags))
          ? d.OMIP.regime_flags
          : (Array.isArray(d.regime_flags) ? d.regime_flags : []);

        let txt =
          `<strong>${date}</strong>` +
          ` · SESI ${fmtNum(sesi,1)}` +
          ` · Structural ${fmtNum(structural,1)}` +
          ` · OMIP ${fmtNum(omipPct,1)}` +
          ` · D ${(disloc===null)?"-":(disloc>=0?"+":"")+fmtNum(disloc,1)}`;

        if (label) txt += ` · <strong>${label}</strong>`;
        if (flags.length) txt += ` · ${flags.join(" | ")}`;

        document.getElementById("todayPill").innerHTML = txt;

        // ----------------
        // Validation pill
        // ----------------
        const vres = await fetch("assets/public/validation_summary.json", { cache: "no-store" });
        if (!vres.ok) throw new Error("validation_summary.json not found");
        const v = await vres.json();

        const thr = (typeof v.thr === "number") ? v.thr : 80;
        const quad = classifyQuadrant(sesi, structural, thr);

        const row = pickRowByQuadrant(v, quad);

        // Support multiple possible field names (robust)
        const mv = pickField(row, [
          "Median 7D max move (€/MWh)",
          "median_future_max_abs_move_7d",
          "future_max_abs_move_7d__median"
        ]);

        const sp = pickField(row, [
          "Median 30D spike freq (|ΔP|>20€/MWh)",
          "median_spike_freq_30d_absdP_gt_20eur",
          "spike_freq_30d_absdP_gt_20eur__median"
        ]);

        const n = pickField(row, [
          "Days (N)",
          "n",
          "count",
          "future_max_abs_move_7d__count"
        ]);

        if (quad && row && typeof mv === "number") {
          const thrTxt = Math.round(thr);
          const spTxt = (typeof sp === "number") ? `${Math.round(sp*100)}%` : "—";
          const nTxt = (typeof n === "number") ? String(n) : "—";

          document.getElementById("valPill").innerHTML =
            `Validation (historical): in regime <strong>${quad}</strong> (thr=${thrTxt}), ` +
            `the typical 7-day max move is <strong>${fmtNum(mv,1)} €/MWh</strong> (median). ` +
            `Spike-days median: <strong>${spTxt}</strong>. Sample: <strong>${nTxt}</strong> days.`;
        } else {
          document.getElementById("valPill").textContent =
            "Validation summary is not available for the current regime (yet).";
        }

      }catch(e){
        document.getElementById("todayPill").textContent = "Today snapshot not available yet.";
        document.getElementById("valPill").textContent = "Validation summary not available yet.";
      }
    })();
  </script>

</body>
</html>
