<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SESI - Spain Energy Stress Index</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="SESI is a public benchmark measuring stress regimes in the Spanish power market.">

  <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/style.css">
</head>

<body>

  <div class="nav">
    <div class="nav-left">
      <img class="brand-mini" src="assets/img/paragua-logo_little.png" alt="Paragua Software">
      <div class="brand-title">
        <strong>Paragua Market Signals</strong>
        <span>Independent research & benchmarks</span>
      </div>
    </div>

    <div class="nav-links">
      <a class="btn primary" href="index.html">Home</a>
      <a class="btn" href="dashboard.html">Dashboard</a>
      <a class="btn" href="methodology.html">Methodology</a>
      <a class="btn" href="data-access.html">Data access</a>
    </div>
  </div>

  <div class="hero">
    <h1>SESI</h1>
    <h2>Spain Energy Stress Index</h2>
    <p class="subtitle">
      A public market stress benchmark for the Spanish power market, designed for
      <strong>risk communication</strong> and <strong>regime monitoring</strong>.
    </p>
  </div>

  <section>
    <h3>What is SESI?</h3>
    <p>
      SESI is an independent market signal designed to track stress regimes in the Spanish electricity market.
      It combines realized spot stress, structural regime distance, and forward-looking market expectations
      into a single, interpretable framework.
    </p>

    <div class="callout">
      <p style="margin:0;">
        SESI is <strong>not</strong> a trading signal and percentiles are <strong>not</strong> probabilities.
      </p>
    </div>
  </section>

  <section>
    <h3>Today’s Snapshot</h3>
    <p class="muted" id="asofText">Latest values reflect market conditions as of the most recent trading day.</p>

    <p>
      <span class="badge omie"><span class="dot"></span>OMIE (spot)</span>
      <span class="badge omip"><span class="dot"></span>OMIP (expected, pct)</span>
      <span class="badge structural"><span class="dot"></span>Structural context</span>
    </p>

    <div class="card">
      <div class="card-title">
        <strong>Today’s Snapshot</strong>
        <span class="muted">visual benchmark (v0.1)</span>
      </div>

      <div class="kpi-grid">
        <div class="kpi omie">
          <div class="label">SESI (realized, pct)</div>
          <div class="value" id="kpiSESI">-</div>
        </div>

        <div class="kpi structural">
          <div class="label">SESI_structural (pct)</div>
          <div class="value" id="kpiStructural">-</div>
        </div>

        <div class="kpi omip">
          <div class="label">Expected stress (OMIP, pct)</div>
          <div class="value" id="kpiOMIP">-</div>
          <div class="muted" style="margin-top:6px;" id="omipLevel">—</div>
        </div>

        <div class="kpi dislocation">
          <div class="label">Dislocation D (pct pts)</div>
          <div class="value" id="kpiD">-</div>
        </div>
      </div>

      <p class="muted" style="margin-top:12px;" id="snapshotStatus">
        Values will be populated automatically via daily publishing.
      </p>

      <!-- Market note -->
      <div style="margin-top:14px;">
        <div class="muted" style="margin-bottom:6px;"><strong>Market note</strong></div>

        <div class="callout">
          <div id="noteShort" style="white-space:pre-wrap;">—</div>

          <details class="verbose" style="margin-top:10px;">
            <summary>Read the full note (verbose)</summary>
            <!-- we render HTML here -->
            <div id="noteVerbose" class="muted" style="margin-top:10px; white-space:normal; line-height:1.7;">—</div>
          </details>
        </div>
      </div>

      <p style="margin-top:12px;">
        <a class="btn primary" href="dashboard.html">Open dashboard</a>
        <a class="btn" href="methodology.html">Read methodology</a>
      </p>
    </div>
  </section>

  <section>
    <h3>Charts</h3>
    <p class="muted">
      SESI is currently published as a visual benchmark using a rolling historical window.
      Canonical views:
    </p>
    <ul>
      <li><strong>Stress dashboard</strong>: SESI vs structural vs expected stress</li>
      <li><strong>Dislocation</strong>: expectations gap vs structural regime</li>
    </ul>

    <p>
      <a class="btn green" href="dashboard.html">Go to charts</a>
    </p>
  </section>

  <footer>
    <div>
      Developed as an independent research project using publicly available market data.
      No proprietary or confidential data sources are used.
    </div>
    <div class="footer-links">
      <a href="dashboard.html">Dashboard</a>
      <a href="methodology.html">Methodology</a>
      <a href="data-access.html">Data access</a>
    </div>
  </footer>

  <script>
    function fmtNum(x, decimals) {
      if (x === null || x === undefined) return "-";
      if (typeof x !== "number") return String(x);
      return x.toFixed(decimals);
    }

    (async function () {
      try {
        const res = await fetch("assets/public/today.json", { cache: "no-store" });
        if (!res.ok) throw new Error("today.json not found");
        const d = await res.json();

        const sesi = (typeof d.SESI === "number") ? d.SESI : null;
        const structural = (typeof d.SESI_structural === "number") ? d.SESI_structural : null;

        const omipPct = (d.OMIP && typeof d.OMIP.omip_exp_pct_pre2022 === "number")
          ? d.OMIP.omip_exp_pct_pre2022 : null;

        const disloc = (d.OMIP && typeof d.OMIP.dislocation_pct_pts === "number")
          ? d.OMIP.dislocation_pct_pts : null;

        const omipAvg = (d.OMIP && typeof d.OMIP.omip_1_3m_avg === "number")
          ? d.OMIP.omip_1_3m_avg : null;

        const omipAsof = (d.OMIP && d.OMIP.asof) ? d.OMIP.asof : (d.omip_asof || null);

        document.getElementById("kpiSESI").textContent = fmtNum(sesi, 1);
        document.getElementById("kpiStructural").textContent = fmtNum(structural, 1);
        document.getElementById("kpiOMIP").textContent = fmtNum(omipPct, 1);
        document.getElementById("kpiD").textContent =
          (disloc === null) ? "-" : (disloc >= 0 ? "+" : "") + fmtNum(disloc, 1);

        // OMIP level line
        if (omipAvg !== null && omipAsof) {
          document.getElementById("omipLevel").textContent =
            `OMIP 1–3M avg: ${fmtNum(omipAvg, 1)} €/MWh (as of ${omipAsof})`;
        } else {
          document.getElementById("omipLevel").textContent = "—";
        }

        // As-of line
        const asof = d.asof_date || d.date || null;
        if (asof) {
          document.getElementById("asofText").textContent =
            `Latest values reflect market conditions as of ${asof}.`;
        }

        // Notes
        // Short note: prefer note_short; fallback to a compact line we can build.
        if (typeof d.note_short === "string" && d.note_short.trim()) {
          document.getElementById("noteShort").textContent = d.note_short;
        } else {
          document.getElementById("noteShort").textContent = "—";
        }

        // Verbose note:
        // Prefer HTML (note_verbose_html). Fallback to markdown/plain text.
        const vHtml = (typeof d.note_verbose_html === "string") ? d.note_verbose_html : null;
        const vMd = (typeof d.note_verbose_md === "string") ? d.note_verbose_md : (typeof d.note_verbose === "string" ? d.note_verbose : null);

        const elVerbose = document.getElementById("noteVerbose");
        if (vHtml && vHtml.trim()) {
          elVerbose.innerHTML = vHtml;
        } else if (vMd && vMd.trim()) {
          elVerbose.textContent = vMd;
          elVerbose.style.whiteSpace = "pre-wrap";
        } else {
          elVerbose.textContent = "—";
        }

        // Status line
        const label = (d.OMIP && d.OMIP.decision_label) ? d.OMIP.decision_label : (d.regime || null);
        const flags = (d.OMIP && Array.isArray(d.OMIP.regime_flags))
          ? d.OMIP.regime_flags
          : (Array.isArray(d.regime_flags) ? d.regime_flags : []);

        let status = "Auto-updated daily.";
        if (label) {
          status = `Auto-updated daily. Regime: ${label}` + (flags.length ? ` | ${flags.join(" | ")}` : "");
        }
        document.getElementById("snapshotStatus").textContent = status;

      } catch (e) {
        console.log("Snapshot not available yet:", e);
      }
    })();
  </script>

</body>
</html>
