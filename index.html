<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>SESI - Spain Energy Stress Index</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="SESI is a public benchmark measuring stress regimes in the Spanish power market.">

  <link rel="icon" href="assets/img/favicon.ico" type="image/x-icon">
  <link rel="stylesheet" href="assets/style.css">
</head>

<body>

  <div class="nav">
    <div class="nav-left">
      <img class="brand-mini" src="assets/img/paragua-logo_little.png" alt="Paragua Software">
      <div class="brand-title">
        <strong>Paragua Market Signals</strong>
        <span>Independent research & benchmarks</span>
      </div>
    </div>

    <div class="nav-links">
      <a class="btn primary" href="index.html">Home</a>
      <a class="btn" href="dashboard.html">Dashboard</a>
      <a class="btn" href="methodology.html">Methodology</a>
      <a class="btn" href="data-access.html">Data access</a>
    </div>
  </div>

  <div class="hero">
    <h1>SESI</h1>
    <h2>Spain Energy Stress Index</h2>
    <p class="subtitle">
      A public market stress benchmark for the Spanish power market, designed for
      <strong>clear risk communication</strong> and <strong>regime monitoring</strong>.
    </p>
  </div>

  <section>
    <h3>What is SESI?</h3>
    <p>
      SESI is an independent benchmark that tracks <strong>market stress regimes</strong> in Spanish electricity.
      It helps answer one simple question:
      <strong>“Are we in a calm regime, or in a regime where the market tends to move a lot?”</strong>
    </p>

    <div class="callout">
      <p style="margin:0;">
        SESI is <strong>not</strong> a trading signal. Percentiles are <strong>rankings</strong>, not probabilities.
      </p>
    </div>
  </section>

  <section>
    <h3>Today’s Snapshot</h3>
    <p class="muted" id="asofText">Latest values reflect market conditions as of the most recent trading day.</p>

    <p>
      <span class="badge omie"><span class="dot"></span>OMIE (spot)</span>
      <span class="badge omip"><span class="dot"></span>OMIP (expected, pct)</span>
      <span class="badge structural"><span class="dot"></span>Structural context</span>
    </p>

    <div class="card">
      <div class="card-title">
        <strong>Today’s Snapshot</strong>
        <span class="muted">visual benchmark (v0.1)</span>
      </div>

      <div class="kpi-grid">
        <div class="kpi omie">
          <div class="label">SESI (realized, pct)</div>
          <div class="value" id="kpiSESI">-</div>
        </div>

        <div class="kpi structural">
          <div class="label">SESI_structural (pct)</div>
          <div class="value" id="kpiStructural">-</div>
        </div>

        <div class="kpi omip">
          <div class="label">Expected stress (OMIP, pct)</div>
          <div class="value" id="kpiOMIP">-</div>
          <div class="muted" style="margin-top:6px;" id="omipLevel">—</div>
        </div>

        <div class="kpi dislocation">
          <div class="label">Dislocation D (pct pts)</div>
          <div class="value" id="kpiD">-</div>
        </div>
      </div>

      <p class="muted" style="margin-top:12px;" id="snapshotStatus">
        Values will be populated automatically via daily publishing.
      </p>

      <!-- ✅ Power metric (simple, public-friendly) -->
      <div style="margin-top:14px;">
        <div class="muted" style="margin-bottom:6px;"><strong>What SESI typically means next (historical)</strong></div>

        <div class="callout">
          <div id="valHeadline" style="font-weight:750;">—</div>
          <div class="muted" id="valExplainer" style="margin-top:6px; line-height:1.6;">—</div>

          <div class="kpi-grid" style="margin-top:12px;">
            <div class="kpi">
              <div class="label">Regime (map)</div>
              <div class="value" id="valRegime">—</div>
            </div>
            <div class="kpi">
              <div class="label">Typical 7D max move</div>
              <div class="value" id="valMove7d">—</div>
              <div class="muted" style="margin-top:6px;">Median, €/MWh</div>
            </div>
            <div class="kpi">
              <div class="label">Spike days (next 30D)</div>
              <div class="value" id="valSpike30d">—</div>
              <div class="muted" style="margin-top:6px;">Median share of days</div>
            </div>
            <div class="kpi">
              <div class="label">Sample size</div>
              <div class="value" id="valN">—</div>
              <div class="muted" style="margin-top:6px;">Historical days</div>
            </div>
          </div>

          <p class="muted" style="margin-top:10px;">
            These are <strong>historical conditional statistics</strong>: what happened after similar regime states in the past.
            They are descriptive and do not imply a forecast.
          </p>

          <p style="margin-top:10px;">
            <a class="btn" href="dashboard.html#validation">See the validation chart</a>
          </p>
        </div>
      </div>

      <!-- Market note -->
      <div style="margin-top:14px;">
        <div class="muted" style="margin-bottom:6px;"><strong>Market note</strong></div>

        <div class="callout">
          <div id="noteShort" style="white-space:pre-wrap;">—</div>

          <details class="verbose" style="margin-top:10px;">
            <summary>Read the full note (verbose)</summary>
            <div id="noteVerbose" class="muted" style="margin-top:10px; white-space:normal; line-height:1.7;">—</div>
          </details>
        </div>
      </div>

      <p style="margin-top:12px;">
        <a class="btn primary" href="dashboard.html">Open dashboard</a>
        <a class="btn" href="methodology.html">Read methodology</a>
      </p>
    </div>
  </section>

  <section>
    <h3>Charts</h3>
    <p class="muted">
      Canonical views:
    </p>
    <ul>
      <li><strong>Stress</strong>: SESI vs structural vs expected stress</li>
      <li><strong>Dislocation</strong>: expectations gap vs structural regime</li>
      <li><strong>Validation</strong>: simple “what usually happens next” by regime</li>
    </ul>

    <p>
      <a class="btn green" href="dashboard.html">Go to charts</a>
    </p>
  </section>

  <footer>
    <div>
      Developed as an independent research project using publicly available market data.
      No proprietary or confidential data sources are used.
    </div>
    <div class="footer-links">
      <a href="dashboard.html">Dashboard</a>
      <a href="methodology.html">Methodology</a>
      <a href="data-access.html">Data access</a>
    </div>
  </footer>

  <script>
    function fmtNum(x, decimals) {
      if (x === null || x === undefined) return "-";
      if (typeof x !== "number") return String(x);
      return x.toFixed(decimals);
    }

    function classifyQuadrant(sesi, structural, thr) {
      if (sesi === null || structural === null) return "—";
      const xHigh = structural >= thr;
      const yHigh = sesi >= thr;
      if (!yHigh && !xHigh) return "Calm";
      if (!yHigh && xHigh) return "Latent risk";
      if (yHigh && !xHigh) return "Realized stress";
      return "Full crisis";
    }

    (async function () {
      try {
        // 1) today.json
        const res = await fetch("assets/public/today.json", { cache: "no-store" });
        if (!res.ok) throw new Error("today.json not found");
        const d = await res.json();

        const sesi = (typeof d.SESI === "number") ? d.SESI : null;
        const structural = (typeof d.SESI_structural === "number") ? d.SESI_structural : null;

        const omipPct = (d.OMIP && typeof d.OMIP.omip_exp_pct_pre2022 === "number")
          ? d.OMIP.omip_exp_pct_pre2022 : null;

        const disloc = (d.OMIP && typeof d.OMIP.dislocation_pct_pts === "number")
          ? d.OMIP.dislocation_pct_pts : null;

        const omipAvg = (d.OMIP && typeof d.OMIP.omip_1_3m_avg === "number")
          ? d.OMIP.omip_1_3m_avg : null;

        const omipAsof = (d.OMIP && d.OMIP.asof) ? d.OMIP.asof : null;

        document.getElementById("kpiSESI").textContent = fmtNum(sesi, 1);
        document.getElementById("kpiStructural").textContent = fmtNum(structural, 1);
        document.getElementById("kpiOMIP").textContent = fmtNum(omipPct, 1);
        document.getElementById("kpiD").textContent =
          (disloc === null) ? "-" : (disloc >= 0 ? "+" : "") + fmtNum(disloc, 1);

        if (omipAvg !== null && omipAsof) {
          document.getElementById("omipLevel").textContent =
            `OMIP 1–3M avg: ${fmtNum(omipAvg, 1)} €/MWh (as of ${omipAsof})`;
        } else {
          document.getElementById("omipLevel").textContent = "—";
        }

        const asof = d.asof_date || d.date || null;
        if (asof) {
          document.getElementById("asofText").textContent =
            `Latest values reflect market conditions as of ${asof}.`;
        }

        // Notes
        if (typeof d.note_short === "string" && d.note_short.trim()) {
          document.getElementById("noteShort").textContent = d.note_short;
        } else {
          document.getElementById("noteShort").textContent = "—";
        }

        const vHtml = (typeof d.note_verbose_html === "string") ? d.note_verbose_html : null;
        const vMd = (typeof d.note_verbose_md === "string") ? d.note_verbose_md : null;

        const elVerbose = document.getElementById("noteVerbose");
        if (vHtml && vHtml.trim()) {
          elVerbose.innerHTML = vHtml;
        } else if (vMd && vMd.trim()) {
          elVerbose.textContent = vMd;
          elVerbose.style.whiteSpace = "pre-wrap";
        } else {
          elVerbose.textContent = "—";
        }

        // Status line
        const label = (d.OMIP && d.OMIP.decision_label) ? d.OMIP.decision_label : (d.regime || null);
        const flags = (d.OMIP && Array.isArray(d.OMIP.regime_flags))
          ? d.OMIP.regime_flags
          : (Array.isArray(d.regime_flags) ? d.regime_flags : []);

        let status = "Auto-updated daily.";
        if (label) {
          status = `Auto-updated daily. Regime: ${label}` + (flags.length ? ` | ${flags.join(" | ")}` : "");
        }
        document.getElementById("snapshotStatus").textContent = status;

        // 2) validation_summary.json (public)
        // This file is generated daily by the engine and published to the public repo.
        const vres = await fetch("assets/public/validation_summary.json", { cache: "no-store" });
        if (!vres.ok) throw new Error("validation_summary.json not found");
        const v = await vres.json();

        const thr = (typeof v.thr === "number") ? v.thr : 80;
        const quad = classifyQuadrant(sesi, structural, thr);
        document.getElementById("valRegime").textContent = quad;

        // Find row for current quadrant (if available)
        const rows = Array.isArray(v.rows) ? v.rows : [];
        const row = rows.find(r => (r["Quadrant"] === quad)) || null;

        if (row) {
          const mv = (typeof row["Median 7D max move (€/MWh)"] === "number") ? row["Median 7D max move (€/MWh)"] : null;
          const sp = (typeof row["Median 30D spike freq (|ΔP|>20€/MWh)"] === "number") ? row["Median 30D spike freq (|ΔP|>20€/MWh)"] : null;
          const n = (typeof row["Days (N)"] === "number") ? row["Days (N)"] : null;

          document.getElementById("valMove7d").textContent = (mv===null) ? "-" : fmtNum(mv, 1);
          document.getElementById("valSpike30d").textContent = (sp===null) ? "-" : fmtNum(sp * 100, 0) + "%";
          document.getElementById("valN").textContent = (n===null) ? "-" : String(n);

          // Headline: simple and punchy
          document.getElementById("valHeadline").textContent =
            `In this regime, the market has typically moved about ${fmtNum(mv,1)} €/MWh within the next 7 days (median).`;

          document.getElementById("valExplainer").textContent =
            `Regime map uses threshold ${thr}. “Typical” means: in the historical sample, half the times the 7-day max move was above this number and half below.`;
        } else {
          document.getElementById("valHeadline").textContent = "Validation snapshot not available for the current regime.";
          document.getElementById("valExplainer").textContent = "—";
        }

      } catch (e) {
        console.log("Snapshot/validation not available yet:", e);
      }
    })();
  </script>

</body>
</html>
